## Тестовый проект по заданию [TASK.md](TASK.md)

### Кратко о проекте
Проект состоит из двух сервисов, объединённых `docker-compose`:
- **display** (Rails 8) — веб-приложение, показывающее температуру по выбранным городам за текущий день с шагом 20 минут.
- **fetcher** (Ruby) — фоновый сборщик, который каждые 20 минут получает текущую температуру из внешнего провайдера и складывает данные в хранилище.

Обмен данными реализован через NATS JetStream Key-Value Bucket (`bucket: weather`).

### Архитектура и поток данных
- **Хранилище**: NATS JetStream KV (контейнер `nats`), bucket создаётся автоматически при первом обращении.
- **Ключи**: `weather/<Город>/<YYYY-MM-DD>`.
- **Значение**: JSON-объект словаря временных слотов → температура, где ключом слота является строка времени формата `HH:MM` в UTC, шаг — 20 минут. Пример:
```json
{
  "00:00": -2.1,
  "00:20": -2.4,
  "00:40": -2.3
}
```
- **fetcher**: раз в 20 минут вычисляет ближайшую «грань» слота, получает температуру у провайдера и пишет/обновляет соответствующий ключ дня.
- **display**: на запрос к `/` читает список пар `(время → температура)` для каждого города текущего дня и строит отображение.

Важно: интервал 20 минут жёстко зашит по обе стороны (в `fetcher` и в `display`). Если вы решите поменять интервал, его нужно изменить согласованно в обоих сервисах.

### Быстрый старт
Требования: Docker и Docker Compose.

1) Запустите все сервисы:
```bash
docker compose up
```

2) Откройте приложение:
`http://localhost:3000`

Примечание: сборщик (`fetcher`) начинает первую запись на ближайшей 20‑минутной «грани» времени. Если вы запустились, например, в 12:07, первая запись произойдёт в 12:20.

### Настройка провайдеров погоды
Поддерживаются два провайдера:
- **OpenMeteo** — по умолчанию, не требует ключа.
- **OpenWeather** — требуется API‑ключ.

Выбор провайдера задаётся в `fetcher/config/fetcher.yml` или через переменные окружения.

Вариант 1. Конфиг-файл (по умолчанию):
```yaml
provider: open_meteo
providers:
  open_meteo: {}
  open_weather:
    api_key: null # или оставьте пустым и задайте ENV OPENWEATHER_API_KEY

storage:
  adapter: nats_kv
  nats_kv:
    bucket: weather
```

Вариант 2. Переменные окружения контейнера `fetcher`:
- `WEATHER_PROVIDER=open_weather`
- `OPENWEATHER_API_KEY=<ваш_ключ>`

### Настройка списка городов
- Для сборщика (`fetcher`) приоритет — конфиг `fetcher/config/cities.yml` (если существует). Если файла нет или список пустой, используется `ENV CITIES` (строка городов через запятую). Если и она не задана — берётся встроенная константа по умолчанию.
  - Пример `cities.yml`:
```yaml
cities:
  - Москва
  - Санкт-Петербург
```
- Пример ENV (в `docker-compose.yml` для сервиса `fetcher`): `CITIES="Москва,Санкт-Петербург,Казань"`.
- Для отображения (`display`) — также через переменную окружения `CITIES` (строка городов через запятую). Пример: `CITIES="Москва,Санкт-Петербург,Казань"`.

Геокодирование городов выполняется через Open-Meteo Geocoding API, координаты кэшируются в том же KV-бакете (`geocode/<urlencoded_city>`).

### Переменные окружения (основные)
- Для `display`:
  - `DATABASE_URL` — строка подключения к Postgres (см. `docker-compose.yml`).
  - `NATS_URL` — URL NATS, по умолчанию `nats://nats:4222` внутри compose-сети.
  - `CITIES` — список городов для отображения, через запятую.
  - `TIME_SLOT_SECONDS` — шаг интервала (в секундах) для выборки и отображения (по умолчанию `1200`, т.е. 20 минут). Должен быть положительным числом.
- Для `fetcher`:
  - `NATS_URL` — URL NATS (должен указывать на сервис `nats`).
  - `WEATHER_PROVIDER` — `open_meteo` (по умолчанию) или `open_weather`.
  - `OPENWEATHER_API_KEY` — ключ для OpenWeather, если выбран `open_weather`.
  - `STORAGE_ADAPTER` — по умолчанию `nats_kv`.
  - `TIME_SLOT_SECONDS` — шаг интервала (в секундах) для выборки и отображения (по умолчанию `1200`, т.е. 20 минут). Должен быть положительным числом.
  - `CITIES` — список городов для отображения, через запятую.

### Разработка
- Оба сервиса в `docker-compose.yml` запущены в dev-режиме с примонтированными томами, изменения в коде отражаются без пересборки образов.

Тесты (пример):
```bash
# display
docker compose run --rm display bin/rails spec

# fetcher
docker compose run --rm fetcher bundle exec rspec
```

### Изменение интервала выборки
Интервал 20 минут зашит в коде в обоих сервисах.
Возможно согласованное изменение интервалов с помощью env TIME_SLOT_SECONDS.

### Структура репозитория (основное)
- `display/` — Rails-приложение (UI)
  - `app/services/weather_storage.rb` — чтение из NATS KV
  - `app/services/weather_service.rb` — построение тайм-слотов и агрегирование
  - `app/services/nats_client.rb` — клиент NATS/JetStream
  - `app/views/weather/index.html.erb` — таблица температур
- `fetcher/` — сборщик
  - `lib/weather_fetcher.rb` — основной цикл (каждые 20 минут)
  - `lib/storage/` — адаптеры хранилища (NATS KV)
  - `lib/weather/providers/` — провайдеры погоды
  - `lib/weather/clients/` — HTTP‑клиенты к внешним API
  - `config/cities.yml` — список городов
  - `config/fetcher.yml` — провайдер/хранилище
- `docker-compose.yml` — оркестрация сервисов

### Конфиги и .gitignore
- Файлы `fetcher/config/cities.yml` и `fetcher/config/fetcher.yml` добавлены в `.gitignore`.
- В репозитории лежат примеры: `fetcher/config/cities.yml.example` и `fetcher/config/fetcher.yml.example`.
- Приложение может запуститься без реальных конфигов: `fetcher` возьмёт города из константы, а провайдер/хранилище имеют дефолты (OpenMeteo + NATS KV). Для OpenWeather задайте `OPENWEATHER_API_KEY`.

